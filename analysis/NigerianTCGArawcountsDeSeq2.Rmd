---
title: "Nigerian-TCGA Differential Expression Analysis Using DeSeq2"
author: "Padma Sheila Rajagopal, MD MPH"
date: "1/23/2019"

site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    df_print: paged
    toc: true
    theme: spacelab
    highlight: textmate
---
```{r Setup, message=FALSE, warning=FALSE, echo=FALSE, results=FALSE, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE)
library("DESeq2")
library(stringi)
library("dplyr")
library("ggplot2")
library("hexbin")
library("AnnotationDbi")
library("org.Hs.eg.db")
library('GenomicFeatures')
library(biomaRt)
library(EnsDb.Hsapiens.v75)
library(apeglm)
library("genefilter")
library(pheatmap)
library("sva")
library(limma)
setwd("~/Research-Local/RNAseq-Local/Inputs/NigerianTCGA_quants")
```

#Translation from HTSeq -> DESeq2 table
I have 86 TCGA patients with whole-genome sequencing data and RNAseq data as well as 99 Nigerian patients with RNA-seq data. Raw counts were initially processed using HTSeq, so HTSeq data is being formatted for use with DESeq2.
```{r Preparing the sampleTable using HTSeq raw counts}
FOLDER <- "/Users/parajago/Research-Local/RNAseq-Local/Inputs/NigerianTCGA_quants"
sampleFiles <- grep("htseq.counts",list.files(FOLDER),value=TRUE)

#Differential gene expression setup based on race (b/w/other)
sampleConditionrace <- sampleFiles
countVar2=1
for (sample in sampleConditionrace){
  if (stri_detect_fixed(sample,"LIB")==TRUE){
    sampleConditionrace[countVar2] <- "Nigerian"
    countVar2=countVar2+1
  } else if (stri_detect_fixed(sample,"black")==TRUE){
    sampleConditionrace[countVar2] <- "TCGA_black"
    countVar2=countVar2+1
  } else if (stri_detect_fixed(sample,"white")==TRUE){
    sampleConditionrace[countVar2] <- "TCGA_white"
    countVar2=countVar2+1
  } else{
    sampleConditionrace[countVar2] <- "TCGA_other"
    countVar2=countVar2+1
  }
}

sampleTable2 <- data.frame(sampleName=gsub(".htseq.counts","",sampleFiles),
                          fileName=sampleFiles,
                          condition=sampleConditionrace)

ddsHTSeqMF <- DESeqDataSetFromHTSeqCount(sampleTable=sampleTable2,
                                       directory=FOLDER,
                                       design=~condition)
```


#Variance transformation, batch effect assessment and initial exploratory analysis
I am now performing different visualization approaches to assess the variance of the data, batch effect and expected differences between the two populations.
```{r Variance transformation and batch effect assessment}
ddsHTSeqMF <- ddsHTSeqMF[rowSums(counts(ddsHTSeqMF)) > 1, ] #Pre-filtering the dataset by removing the rows without information about gene expression

dds <- estimateSizeFactors(ddsHTSeqMF) #The size factor is the median ratio of the sample over a "pseudosample": for each gene, the geometric mean of all samples.
dds$condition <- relevel(dds$condition, ref = "Nigerian") #explicitng making the Nigerian patients the reference population 

vsd <- vst(ddsHTSeqMF, blind = TRUE) #Variance-stabilizing transformation

df <- bind_rows( #Graphical representation of the variance-stabilizing transformation
          as_data_frame(log2(counts(dds, normalized=TRUE)[, 1:2]+1)) %>%
          mutate(transformation = "log2(x + 1)"),
          as_data_frame(assay(vsd)[, 1:2]) %>% mutate(transformation = "vst"))
          colnames(df)[1:2] <- c("x", "y")

ggplot(df, aes(x = x, y = y)) + labs(subtitle="Figure 1: Graphical representation of the \nvariance-stabilizing transformation \nrelative to the standard transformation of log2(x+1).\nThis reduces variance purely due to low read counts") + geom_hex(bins = 80) +
  coord_fixed() + facet_grid( . ~ transformation) 

plotPCA(vsd) + labs(subtitle = "PCA 1: first PCA demonstrates batch effect between\nthe Nigerian patients and TCGA patients,\nwhich would be presumed given that these experiments\nwere done in different settings at different times.\nThe TCGA patients also appear to have internal\nbatch effect that is not race-driven\ngiven distribution into 2 separate groups") #PCA1: Raw counts

topVarGenes <- head(order(rowVars(assay(vsd)), decreasing = TRUE), 1000)
hm  <- assay(vsd)[ topVarGenes, ]
hm  <- hm - rowMeans(hm)
anno <- as.data.frame(colData(vsd)[, c("condition")])
rownames(anno) <- colnames(vsd)
pheatmap(hm, annotation_col = anno, cluster_rows=FALSE, show_rownames=FALSE,
         cluster_cols=FALSE, main="Heat map 1: \nRelative VST-transformed counts across samples")

mat <- assay(vsd) #PCA2: Removing the batch effect created by the separate batch processing of the TCGA and Nigerian samples (although this may overcorrect for the actual difference between these two populations).  
mat <- limma::removeBatchEffect(mat, vsd$condition)
assay(vsd) <- mat
plotPCA(vsd) + labs(subtitle="PCA2: The second PCA represents removal of batch effect using the limma removeBatchEffect method.\nThis largely accounts for the batch effect noticed in PCA1. \nThere remain some outliers, primarily from the Nigerian patients.")

topVarGenes <- head(order(rowVars(assay(vsd)), decreasing = TRUE), 1000)
hm  <- assay(vsd)[ topVarGenes, ]
hm  <- hm - rowMeans(hm)
anno <- as.data.frame(colData(vsd)[, c("condition")])
rownames(anno) <- colnames(vsd)
pheatmap(hm, annotation_col = anno, cluster_rows=FALSE, show_rownames=FALSE,
         cluster_cols=FALSE, main="Heat map 2: Batch-effect-corrected relative\n VST-transformed counts across samples")
```


#Using sva to additionally account for batch effect related to the Nigerian/TCGA samples
```{r Batch effect assessment, message=FALSE}
dat  <- counts(dds, normalized = TRUE)
idx  <- rowMeans(dat) > 1
dat  <- dat[idx, ]
mod  <- model.matrix(~condition, colData(dds))
mod0 <- model.matrix(~   1, colData(dds))
svseq <- svaseq(dat, mod, mod0, n.sv = 1)

sampleTablebe <- data.frame(sampleName=gsub(".htseq.counts","",sampleFiles),
                          fileName=sampleFiles,
                          condition=sampleConditionrace, 
                          be=svseq$sv[,1])

ddsHTSeqMFbe <- DESeqDataSetFromHTSeqCount(sampleTable=sampleTablebe,
                                       directory=FOLDER,
                                       design=~condition + be)

ddsHTSeqMFbe <- ddsHTSeqMFbe[rowSums(counts(ddsHTSeqMFbe)) > 1, ]
```
